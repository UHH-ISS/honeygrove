import sys, os
sys.path.append(os.path.abspath(__file__ + "/../../.."))

import hashlib
import subprocess
import json
import time
import glob
from datetime import datetime
from incidentmonitoring.CIMBroker.CIMBrokerConfig import es


class MalwareLookup():

        @staticmethod
        def hashingFile():
                '''
                
                :return: 
                '''

                # big files are divided into smaller blocks to save memory.
                BLOCKSIZE = 65536
                hasher = hashlib.sha1()
                timestamp = datetime.utcnow().isoformat()

                # last created filename in directory
                newest = os.path.basename(max(glob.iglob('./incidentmonitoring/ressources/*.file'), key=os.path.getctime))

                # read the file und hash the blocks
                with open('./incidentmonitoring/ressources/%s' % newest, 'rb') as afile:
                        buffer = afile.read(BLOCKSIZE)
                        while len(buffer) > 0:
                                hasher.update(buffer)
                                buffer = afile.read(BLOCKSIZE)

                whois = ['whois', '-h', 'hash.cymru.com', hasher.hexdigest()]
                whois = " ".join(whois)

                # result auf the whois inquiry
                try:
                        stdoutdata = subprocess.check_output(whois, shell=True, stderr=subprocess.STDOUT)
                except subprocess.CalledProcessError as e:
                        stdoutdata = e.output

                # split our output into 3 strings.
                hash = str(stdoutdata.decode().split(' ')[0])
                found = str(stdoutdata.decode().split(' ')[1])
                percent = str(stdoutdata.decode().replace('NO_DATA', '\n').replace('\n', '').split(' ')[2])
                infolink = 'https://www.virustotal.com/en/search/?query=' + hash        #Warning of virustotal

                # convert the timestamp from unix epoch to gmt datetime.
                found_date = time.strftime('%Y-%m-%dT%H:%M:%S.000000', time.gmtime(int(found)))

                # parsing of elasticsearch compatibel logs.
                bmessage = json.dumps(
                        {'@timestamp': timestamp, 'hash': hash, 'percent': percent, 'found_date': found_date,
                         'infolink': infolink, 'filename': '%s.file' % timestamp})

                # send logs to elasticsearch
                es.index(index='honeygrove', doc_type='malware', body=bmessage)

if __name__ == '__main__':

        MalwareLookup.hashingFile()